# å‰è¨€
äº†è§£è®¡ç®—æœºä¹‹è‡ªåº•å‘ä¸Šå¼ã€‚å¤§å®¶å¥½ï¼Œæˆ‘æ˜¯laterã€‚æœ¬æ–‡ä¼šä»‹ç»ä¸€ä¸ªèƒ½è¿è¡Œâ€œ[2048](https://github.com/rpendleton/lc3-2048)â€æ¸¸æˆçš„è™šæ‹Ÿæœºï¼Œæ³¨ï¼šå¹¶ä¸éœ€è¦è‡ªå·±å†™ 2048æ¸¸æˆï¼Œéœ€è¦è‡ªå·±æ¨¡æ‹Ÿ è¯¥æ¸¸æˆçš„è¿è¡Œç¯å¢ƒã€‚è¿™æ˜¯ä¸€ä¸ªæœ‰æ„æ€çš„è¯é¢˜ï¼Œä»€ä¹ˆå«åš æ¸¸æˆçš„è¿è¡Œç¯å¢ƒå‘¢ï¼Ÿ ä»ä¸Šé¢ç»™å‡ºçš„æ¸¸æˆé“¾æ¥ï¼Œæˆ‘ä»¬å¯ä»¥è·å–ä¸€ä¸ª2048.objï¼Œè¿™å°±æ˜¯è¦è¿è¡Œçš„2048æ¸¸æˆç¨‹åºï¼Œä½†æ˜¯æˆ‘ä»¬ä¸èƒ½å°†å®ƒè¿è¡Œåœ¨windowsæˆ–è€…linuxä¸Šï¼Œé¢ï¼Œè¿™æ˜¯ä¸ºä»€ä¹ˆå‘¢ï¼Ÿè¿™é‡Œç®€å•è¯´å°±æ˜¯ objä¸æ˜¯ä¸€ä¸ªwindowså’Œlinuxçš„å¯æ‰§è¡Œç¨‹åºï¼Œobjé‡Œé¢çš„æŒ‡ä»¤ä¸æ˜¯ x86å’Œarmç­‰å¸¸è§å¹³å°çš„ï¼Œè¿™ä¸ªobjæ˜¯éœ€è¦è¿è¡Œåˆ° å’±ä»¬è‡ªå·±å®ç°çš„è™šæ‹Ÿæœºä¸­çš„ã€‚å°±åƒä¸‹é¢è¿™æ ·ï¼š
```shell
./lc3 2048.obj
```
![|400](https://raw.githubusercontent.com/later-3/blog-img/main/20220611125017.png)

```ad-note
æ³¨ï¼šæœ¬æ–‡å†…å®¹å‚è€ƒ [Write your Own Virtual Machine (jmeiners.com)](https://www.jmeiners.com/lc3-vm/)
```

# ç›®å½•
- [[#1 è™šæ‹Ÿæœºä»‹ç»]]
- [[#2 LC-3 æ¶æ„]] 
- [[#3 LC-3æ±‡ç¼–]]
- [[#4 æ‰§è¡Œç¨‹åº]]
- [[#5 æŒ‡ä»¤ç¿»è¯‘]]
- [[#6 æŒ‡ä»¤å¤‡å¿˜å•]]
- [[#7 trap routines]]
- [[#8 LC-3 endianness]]
- [[#9 å†…å­˜æ˜ å°„å¯„å­˜å™¨]]
- [[#10 ä¼˜åŒ–]]
- [[#11 æ€»ç»“]]

# 1. è™šæ‹Ÿæœºä»‹ç»
å¦‚æœè¦ä»è™šæ‹ŸåŒ–è°ˆèµ·ï¼Œä¼š å¤ªå¤ªå¤ª å†—é•¿äº†(å®é™…æ˜¯laterå¯¹è™šæ‹ŸåŒ–ä¹Ÿä¸æ˜¯å¾ˆäº†è§£)ã€‚æœ¬æ–‡æ‰€ä»‹ç»çš„è™šæ‹Ÿæœºå®é™…å°±æ˜¯ä¸€ä¸ªLinuxä¸‹é¢çš„å¯æ‰§è¡Œç¨‹åºï¼Œå®ƒå¯ä»¥è§£æ2048.objè¿™ä¸ªäºŒè¿›åˆ¶ã€‚è¿›ä¸€æ­¥çš„ï¼Œè¿™ä¸ªè™šæ‹Ÿæœºçš„åå­—å«åšï¼š[lc3-vm](https://en.wikipedia.org/wiki/Little_Computer_3)( little computer)ï¼Œå®ƒå°±åƒæ˜¯ä¸€ä¸ªâ€œè®¡ç®—æœºâ€ï¼Œå®ƒæ¨¡æ‹Ÿäº†ä¸€ä¸ªcpuå’Œä¸€äº›ç¡¬ä»¶ï¼Œå¯ä»¥åšç®—æœ¯è¿ç®—ã€è¯»å†™å†…å­˜ã€ä¸I/Oè®¾å¤‡äº¤äº’ã€‚å†è¿›ä¸€æ­¥ï¼Œä¸€ä¸ªç¨‹åºä¸­æœ‰ä»€ä¹ˆå‘¢ï¼Ÿæœ‰äººè¯´ï¼šä»£ç æ®µã€æ•°æ®æ®µ...... å—¯ï¼Œlaterè§‰å¾—è¿™æ ·çš„åŒå­¦åŸºç¡€éå¸¸æ‰å®ï¼æœ‰äº›åŒå­¦å¯èƒ½ç”¨çš„æ˜¯javaæˆ–è€…pythonï¼Œä½†å½’æ ¹ç»“åº•ï¼Œå’±ä»¬å†™çš„ç¨‹åºç»è¿‡ç¼–è¯‘è¢«ç¿»è¯‘æˆäº†äºŒè¿›åˆ¶ï¼Œè¿™ä¸ªäºŒè¿›åˆ¶é‡Œé¢åŒ…å«äº†ä¸€äº›æ•°æ®ï¼Œæ›´é‡è¦çš„æ˜¯ï¼ŒåŒ…å«äº†ä¸€äº›"cpuï¼ˆå¯èƒ½æ˜¯ç‰©ç†çš„cpuï¼Œå¯èƒ½æ˜¯è½¯ä»¶æ¨¡æ‹Ÿçš„cpuï¼‰"èƒ½æ‰§è¡Œçš„æŒ‡ä»¤ã€‚åœ¨æœ¬æ–‡ä¸­çš„è™šæ‹Ÿæœºèƒ½å¤Ÿæ‰§è¡Œ 2048.obj ä¸­çš„æŒ‡ä»¤ï¼Œé¢ï¼Œå…¶å®è¿™ä¹ˆè¯´æ˜¯æ²¡æœ‰é”™çš„ï¼Œä½†æ˜¯å®é™…ä¸Š æœ‰ç‚¹æ€ªæ€ªçš„ï¼Œå› ä¸ºlc3-vmæ˜¯ä¸€ä¸ªéµå¾ª "[The lC-3 ISA](http://users:csc:calpoly:edu/~cesiu/csc225/slides/lc3isa.pdf)"çš„è™šæ‹Ÿæœºï¼Œè€Œ2048.objå°±æ˜¯ä¸ºäº†åœ¨ â€œThe IC-3 ISA" ä¸Šè¿è¡Œçš„ç¨‹åºã€‚

å¦å¤–ï¼Œåé¢laterè¿˜ä¼šä»‹ç»å…¶ä»–çš„æ¨¡æ‹Ÿå™¨ï¼šèƒ½ç© è¶…çº§é©¬é‡Œå¥¥ çš„NES æ¨¡æ‹Ÿå™¨ï¼ˆNESæ¨¡æ‹Ÿå™¨æ¨¡æ‹Ÿäº†å’±ä»¬å°æ—¶å€™çš„ å°éœ¸ç‹ç”µè„‘ï¼Œè¿™ä¸ªå°ç”µè„‘é‡Œé¢æœ‰ä¸€é¢— [6502cpu](http://www.6502.org/tutorials/)ï¼‰ã€è¿è¡Œ riscv ç¨‹åºçš„æ¨¡æ‹Ÿå™¨ã€å¤§åé¼é¼çš„ [QEMU](https://www.qemu.org/)ï¼ˆæ¢ç´¢linuxçš„åˆ©å™¨ï¼‰ã€‚ 

## ä¸ºä»€ä¹ˆè¦å†™è™šæ‹Ÿæœº
å†™è™šæ‹Ÿæœºå¯ä»¥æ›´æ·±å…¥çš„äº†è§£è®¡ç®—æœºçš„å·¥ä½œåŸç†ã€‚

## æ‰€éœ€è¦åšçš„å·¥ä½œ
å°±åƒå‰è¨€æ‰€è¯´çš„é‚£æ ·æˆ‘ä»¬éœ€è¦å†™ä¸€ä¸ªè™šæ‹Ÿæœºï¼Œå¤§æ¦‚å°±æ˜¯500è¡Œå·¦å³çš„cç¨‹åºã€‚æ³¨ï¼š2048æ¸¸æˆä¸éœ€è¦æˆ‘ä»¬å†™ï¼Œæˆ‘ä»¬å°±æŠŠè¿™ä¸ª2048.objå½“åšæ˜¯è¿è¡Œåœ¨è™šæ‹Ÿæœºä¸­çš„ç¨‹åºå°±å¥½ï¼Œé™¤äº†2048è¿˜æœ‰å…¶ä»–çš„æ¸¸æˆï¼Œä¾‹å¦‚ï¼š[justinmeiners/lc3-rogue: Roguelike tunnel generator in LC3 assembly. (Homework) (github.com)](https://github.com/justinmeiners/lc3-rogue)

## ç¯å¢ƒ
æœ¬æ–‡ä½¿ç”¨wsl2 ubuntu20.04ä½œä¸ºå¼€å‘ç¯å¢ƒã€‚ 


# 2. LC-3 æ¶æ„
LC-3ç›¸æ¯” x86 æ¶æ„è€Œè¨€ï¼ŒæŒ‡ä»¤é›†éå¸¸ç®€å•ï¼Œä½†åŒ…å«äº†å‡ ä¹æ‰€æœ‰çš„ç°ä»£CPUçš„æ ¸å¿ƒå†…å®¹ã€‚

## LC-3ç›¸å…³èµ„æº
ä¸€äº›å…³äº LC-3 çš„ç›¸å…³èµ„æºï¼š[Introduction to Computing Systems (mheducation.com)](https://highered.mheducation.com/sites/0072467509/student_view0/index.html)ï¼Œ æœ‰å¾ˆå¤šå›½å¤–å­¦æ ¡çš„æœ¬ç§‘ç”Ÿè®¡ç®—æœºå…¥é—¨è¯¾ç¨‹ç”¨åˆ°äº†LC-3(æˆ–è€…lc3)ã€‚æ¨èä¸€æœ¬ä¹¦ï¼š[Introduction To Computing Systems: From Bits & Gates To C/C++ & Beyond, Third Edition (icourse.club)](https://icourse.club/uploads/files/96a2b94d4be48285f2605d843a1e6db37da9a944.pdf)ã€‚ æœ¬ä¹¦ç±»ä¼¼ä¸€æœ¬è®¡ç®—æœºçš„æ•™ç§‘ä¹¦ï¼Œå…¶å®å®ƒå°±æ˜¯ã€‚æ˜¯éå¸¸å¥½çš„å…¥é—¨èµ„æ–™ï¼Œå…¨ä¹¦ ä¾æ® **è‡ªåº•å‘ä¸Š** çš„æ–¹æ³•ï¼Œä»é€»è¾‘é—¨ç”µè·¯å¼€å§‹è®²èµ·ï¼Œåˆ°å†¯è¯ºä¾æ›¼ï¼Œå†åˆ°LC-3æ¶æ„ï¼Œæœ€åcè¯­è¨€ç­‰ç­‰ã€‚


## Memory
é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦æ¨¡æ‹Ÿè®¡ç®—æœºçš„åŸºæœ¬ç¡¬ä»¶ç»„ä»¶ã€‚==LC-3æ˜¯åŸºäºå†¯è¯ºä¾æ›¼æ¶æ„çš„==ï¼Œæˆ‘ä»¬å…ˆä» memory å¼€å§‹ã€‚

LC-3çš„åœ°å€ç©ºé—´æ˜¯0 ~ 65536ï¼Œ ä¹Ÿå°±æ˜¯2^16ï¼Œç”¨ä¸€ä¸ª16ä½çš„æ— ç¬¦å·æ•´å‹åˆšå¥½å¯ä»¥è¡¨ç¤ºï¼Œæ¯ä¸ªåœ°å€å­˜æ”¾16bitæ•°æ®ã€‚æ‰€ä»¥ ä¸€å…±çš„ åœ°å€ç©ºé—´èƒ½å¤Ÿè¡¨ç¤ºï¼š65536 * 2 = 128KBï¼Œè¿™æ¯”æˆ‘ä»¬ç°åœ¨ä½¿ç”¨çš„ç”µè„‘å°å¤ªå¤šäº†ï¼Œä½†è¿™ä¹Ÿæ„å‘³ç€å®ƒè¶³å¤Ÿç®€å•ã€‚

> Memory Storage
```c
#define MEMORY_MAX (1 << 16)

uint16_t memory[MEMORY_MAX];  /* 65536 locations */
```

ä¸Šé¢å°±æ˜¯ ç”¨cè¯­è¨€è¡¨ç¤ºçš„ LC-3 çš„memoryï¼Œ 1 << 16 æ˜¯65536ï¼Œuint16_t æ˜¯16ä½æ•´å‹ï¼Œå³ï¼šé•¿åº¦ä½65536çš„16ä½æ•´å‹æ•°ç»„æ¥è¡¨ç¤ºmemoryã€‚

## Registers
ç°ä»£å¤„ç†å™¨éƒ½ä¼šæœ‰å¯„å­˜å™¨ï¼Œå¯„å­˜å™¨å­˜åœ¨çš„åŸå› æ˜¯ï¼ŒCPUç›´æ¥è®¿é—®å†…å­˜æˆ–è€…å¤–è®¾ï¼Œå…¶è®¿é—®é€Ÿåº¦ç›¸æ¯”CPUçš„å¤„ç†é€Ÿåº¦æ˜¯éå¸¸æ…¢çš„ï¼Œäºæ˜¯åœ¨CPUå†…éƒ¨æœ‰ä¸€äº›å­˜å‚¨å•å…ƒï¼ŒCPUè®¿é—®è¿™äº›å­˜å‚¨å•å…ƒä¼šæ¯”è¾ƒå¿«ã€‚è¿™äº›å­˜å‚¨å•å…ƒå°±æ˜¯ Registerã€‚

LC-3ä¹Ÿæœ‰å¯„å­˜å™¨ï¼Œå¯„å­˜å™¨é€šå¸¸åˆ†ä¸º é€šç”¨å¯„å­˜å™¨ã€æ ‡å¿—å¯„å­˜å™¨ã€ç‰¹æ®Šå¯„å­˜å™¨ï¼ˆPCã€SPç­‰ï¼‰ã€‚å°†æ§åˆ¶å™¨ä»å†…å­˜è¯»å–çš„æ•°æ®æ”¾åˆ°å¯„å­˜å™¨ä¸­ï¼Œæˆ–è€…å°†å¯„å­˜å™¨ä¸­çš„æ•°æ®æ”¾åˆ°å†…å­˜ä¸­ï¼Œè¿™ä¸€èˆ¬ç”¨åˆ°çš„æ˜¯é€šç”¨å¯„å­˜å™¨ã€‚æ ‡å¿—å¯„å­˜å™¨å’Œç‰¹æ®Šå¯„å­˜å™¨ä¸€æ–¹é¢æ˜¯ä¸ºäº†è¡¨ç¤ºæŒ‡ä»¤æ‰§è¡Œçš„çŠ¶æ€æˆ–CPUçš„çŠ¶æ€ï¼Œå¦ä¸€æ–¹é¢æ˜¯ä¸ºäº†ç¼–ç¨‹ä½¿ç”¨ã€‚

LC-3å…±æœ‰10ä¸ªå¯„å­˜å™¨ï¼Œæ¯ä¸€ä¸ªéƒ½å¯ä»¥å­˜æ”¾16bitæ•°æ®ï¼Œè¿™æ­£å¥½æ˜¯æ¯ä¸ªå†…å­˜ä¸­å­˜æ”¾çš„æ•°æ®çš„å¤§å°ã€‚
- 8ä¸ªé€šç”¨å¯„å­˜å™¨ï¼Œä»¥R0~R7ç¼–å·ã€‚
- ç¨‹åºè®¡æ•°å™¨PCï¼Œè¿™æ˜¯å¤„ç†å™¨çš„æ ‡é…ã€‚
- ä¸€ä¸ªæ¡ä»¶æ ‡å¿—å¯„å­˜å™¨ï¼šCOND

PCçš„ä½œç”¨å¾ˆå•çº¯ï¼Œå°±æ˜¯æŒ‡å‘ä¸‹ä¸€æ¡å°†è¦æ‰§è¡Œçš„æŒ‡ä»¤çš„åœ°å€ï¼Œæ‰€ä»¥PCè‚¯å®šæ˜¯å¤§äºç­‰äº16bitçš„ï¼Œç­”æ¡ˆæ˜¯ 16bitï¼Œæ‰€æœ‰å¯„å­˜å™¨éƒ½æ˜¯16bitçš„ã€‚CONDä¼šæä¾›æ¯æ¬¡æ‰§è¡ŒæŒ‡ä»¤ä¹‹åçš„ç›¸å…³ä¿¡æ¯ï¼Œæ¯”å¦‚åšäº†ä¸€ä¸ªå‡æ³•ï¼Œé€šè¿‡CONDå¯ä»¥çŸ¥é“å‡æ³•çš„ç»“æœæ˜¯æ­£æ•°è¿˜æ˜¯0ï¼Œæˆ–è€…è´Ÿæ•°ã€‚

> Registers
```c
enum {
	R_R0 = 0,
	R_R1,
	R_R2
	R_R3,
	R_R4,
	R_R5,
	R_R6,
	R_R7,
	R_PC,
	R_COUNT
}

uint16_t reg[R_COUNT];
```

åŒæ ·ç”¨ä¸€ä¸ªå¯„å­˜å™¨æ•°ç»„æ¥è¡¨ç¤º LC-3çš„å¯„å­˜å™¨ï¼Œç”¨æšä¸¾çš„æœ€åä¸€ä¸ªå€¼æ¥è¡¨ç¤ºå¯„å­˜å™¨çš„æ•°é‡ï¼Œè¿™æ˜¯ä¸€ä¸ªéå¸¸å¥½çš„æ–¹æ³•ï¼Œä¸€æ–¹é¢é¿å…äº†å•ç‹¬å®šä¹‰ä¸€ä¸ªå®æ¥è¯´æ˜æ•°é‡ï¼Œå¦ä¸€æ–¹é¢åˆ«äººåœ¨é˜…è¯»ä»£ç çš„æ—¶å€™ï¼Œä¼šå¾ˆå®¹æ˜“å°†å¯„å­˜å™¨çš„ç›¸å…³å®šä¹‰éƒ½æ‰¾åˆ°ã€‚

## æŒ‡ä»¤é›†
ç¨‹åºå‘˜å’Œå¤„ç†å™¨æ²Ÿé€šçš„æ–¹å¼æ˜¯æŒ‡ä»¤ã€‚æ¯æ¬¾cpuéƒ½æœ‰å…¶èƒ½å¤Ÿè¯†åˆ«çš„æŒ‡ä»¤ï¼Œè¯´cpuå¬å¾—æ‡‚çš„è¯(æŒ‡ä»¤)ï¼Œcpuæ‰èƒ½å¹²æ´»å„¿ã€‚

LC-3æœ‰ä¸€å¥—è‡ªå·±çš„æŒ‡ä»¤é›†ï¼Œ 2048.obj è¿™ä¸ªæ¸¸æˆé‡Œé¢ å°±åŒ…å«äº† LC-3èƒ½å¤Ÿè¯†åˆ«çš„æŒ‡ä»¤ã€‚

æŒ‡ä»¤ç”± **opcode**(æ“ä½œç ï¼šæŒ‡ä»¤è¦åšå•¥) + **operands**(æ“ä½œæ•°ï¼šè°å»åšï¼Œä¸€èˆ¬æ˜¯å¯„å­˜å™¨)ï¼Œ[[ITCS]] çš„4.3.1ç« èŠ‚æœ‰è¯¦ç»†æè¿°ã€‚

ç®€è€Œè¨€ä¹‹ï¼ŒLC-3çš„æŒ‡ä»¤æ˜¯ç”± `16bit` ç»„æˆçš„ï¼Œå‰é¢4bitè¡¨ç¤ºçš„æ˜¯ opcodeï¼Œåé¢æ˜¯operandsã€‚
LC-3å…±æœ‰16ä¸ªopcodeï¼Œåˆ†ä¸ºä¸‰ç±»ï¼š
- æ•°æ®æ¬ç§»ï¼šå¯„å­˜å™¨ä¹‹é—´ã€å¯„å­˜å™¨ä¸å†…å­˜ä¹‹é—´ã€‚
- æ§åˆ¶ï¼šä¸ºäº†æ”¹å˜æŒ‡ä»¤åºåˆ—ï¼Œä¸€èˆ¬æŒ‡ä»¤æ˜¯ä¸€æ¡æ¥ç€ä¸€æ¡æŒ‡ä»¤ï¼Œæ§åˆ¶ç±»æŒ‡ä»¤å¯ä»¥å®Œæˆè·³è½¬ï¼Œä¸æŒ‰é¡ºåºæ‰§è¡Œï¼Œè¿™æ˜¯æ”¯æŒå‡½æ•°å’Œæ¡ä»¶åˆ¤æ–­çš„åŸºç¡€ã€‚
- æ“ä½œï¼šè¿™ç±»æŒ‡ä»¤æœ€å¥½ç†è§£ï¼Œå°±æ˜¯åŠ æ³•å’Œä¸¤ä¸ªé€»è¾‘è¿ç®—ï¼šAND ã€ NOT

è¯¦ç»†çš„æŒ‡ä»¤è§£é‡Šå’Œå«ä¹‰åœ¨ [[ITCS]]çš„ç¬¬äº”ç« ã€‚

> Opcodes
```c
enum
{
	OP_BR = 0, /* branch */
	OP_ADD,    /* add  */
	OP_LD,     /* load */
	OP_ST,     /* store */
	OP_JSR,    /* jump register */
	OP_AND,    /* bitwise and */
	OP_LDR,    /* load register */
	OP_STR,    /* store register */
	OP_RTI,    /* unused */
	OP_NOT,    /* bitwise not */
	OP_LDI,    /* load indirect */
	OP_STI,    /* store indirect */
	OP_JMP,    /* jump */
	OP_RES,    /* reserved (unused) */
	OP_LEA,    /* load effective address */
	OP_TRAP    /* execute trap */
};
```

æ¯ä¸ªæ“ä½œç éƒ½æœ‰å¯¹åº”çš„åå­—ï¼Œç”¨æšä¸¾å®šä¹‰å‡ºæ¥ï¼Œè¿™æ ·æ—¢æ–¹ä¾¿çŸ¥é“æ˜¯å“ªä¸ªæ“ä½œç (æ ¹æ®æšä¸¾çš„åå­—)ï¼Œåˆæ–¹ä¾¿åœ¨å†™ä»£ç æ˜¯åˆ¤æ–­(æšä¸¾å€¼å®é™…éƒ½æ˜¯æ•´å‹)ï¼Œè¿™æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„æ–¹æ³•ğŸ˜ƒã€‚


## æ¡ä»¶æ ‡å¿—
åœ¨å†™ç¨‹åºæ—¶ï¼Œå¾€å¾€ä¼šæœ‰å¾ˆå¤šåˆ¤æ–­ï¼Œè¿™æ—¶å°±ä¼šç”¨ä¸Š `R_COND` å¯„å­˜å™¨ï¼Œè¯¥å¯„å­˜å™¨å­˜å‚¨äº†ä¸Šä¸€æ¡æŒ‡ä»¤æ‰§è¡Œæƒ…å†µçš„ç›¸å…³ä¿¡æ¯ã€‚æ¡ä»¶åˆ¤æ–­å°±ä¼šç”¨åˆ°è¯¥å¯„å­˜å™¨ã€‚

LC-3åªæœ‰ä¸‰ç§æ¡ä»¶æ ‡å¿—ï¼š
```c
enum {
	FL_POS = 1 << 0, /\* p \*/
	FL_ZRO = 1 << 1, /\* Z \*/
	FL_NEG = 1 << 2, /\* N \*/
};
```

å¦‚ä¸Šæ‰€ç¤ºï¼Œè¿™ä¸ªå¯„å­˜å™¨çš„ç¬¬ä¸€ä¸ªbitä½è¡¨ç¤ºæ­£æ•°ï¼Œç¬¬äºŒä¸ªè¡¨ç¤º0ï¼Œç¬¬ä¸‰ä¸ªè¡¨ç¤ºè´Ÿæ•°ã€‚å¦‚æœä¸Šä¸€æ¬¡è®¡ç®—çš„ç»“æœæ˜¯0ï¼Œé‚£ç¬¬äºŒä¸ªbitä½ä¸º1ã€‚

åŸºäºä»¥ä¸Šï¼Œç¡¬ä»¶ç»„ä»¶çš„åŸºæœ¬å®šä¹‰å·²ç»å®Œæˆäº†ã€‚

# 3. LC-3æ±‡ç¼–
æ±‡ç¼–è¯­è¨€æ˜¯æ¯”cè¯­è¨€è¿˜åº•å±‚çš„è¯­è¨€ï¼Œå®ƒå’ŒæŒ‡ä»¤ä¸€ä¸€å¯¹åº”ã€‚lc-3çš„æ±‡ç¼–æœ‰å¯¹åº”çš„æ±‡ç¼–å™¨ç¿»è¯‘æˆlc-3çš„æŒ‡ä»¤ã€‚ä¸‹é¢å…ˆçœ‹ä¸€ä¸ª Hello World çš„ä¾‹å­ï¼š
> Hello World Assembly

```asm
.ORIG x3000                        ; this is the address in memory where the program will be loaded
LEA R0, HELLO_STR                  ; load the address of the HELLO_STR string into R0
PUTs                               ; output the string pointed to by R0 to the console
HALT                               ; halt the program
HELLO_STR .STRINGZ "Hello World!"  ; store this string here in the program
.END                               ; mark the end of the file
```

åˆ«è¯´è¯ï¼Œå…ˆæŠŠä¸Šé¢çš„ä»£ç è·‘èµ·æ¥å§ã€‚ å…ˆä» [ lc3-tools](https://highered.mheducation.com/sites/dl/free/0072467509/104652/lc3tools_v12.zip)  è¿™é‡Œä¸‹è½½ç¼–è¯‘å·¥å…·ï¼Œå°†ä¸Šé¢ä»£ç ä¿å­˜ä¸º hello_world.asm ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬å°†è¿™ä¸ªlc-3çš„æ±‡ç¼–æ–‡ä»¶ç¼–è¯‘ä¸º lc-3 çš„å¯æ‰§è¡ŒäºŒè¿›åˆ¶æ–‡ä»¶ã€‚

## ç¼–è¯‘ lc3-tools
ä¸Šé¢é“¾æ¥ç»™åˆ°çš„å·¥å…·é‡Œé¢åŒ…å«äº† ç¼–è¯‘å’Œæ¨¡æ‹Ÿå™¨çš„æºç ï¼Œæˆ‘ä»¬å…ˆå·¥å…·éƒ½ç¼–è¯‘å‡ºæ¥ã€‚
æ³¨ï¼šlateræ˜¯åœ¨ wsl2 é‡Œé¢å®Œæˆã€‚ 

```shell
cd     lc3tools
make
```

å¯èƒ½éœ€è¦æ ¹æ®æç¤ºå®Œæˆä¸€äº›chmodï¼Œæœ€ç»ˆçœ‹åˆ°
![|400](https://raw.githubusercontent.com/later-3/blog-img/main/20220911165625.png)
å°±ç¼–è¯‘å¥½äº†ã€‚ç›®å½•ä¸‹é¢çš„lc3simå°±æ˜¯lc3çš„æ¨¡æ‹Ÿå™¨ã€‚

## ç¼–è¯‘hello_world.asm
![|500](https://raw.githubusercontent.com/later-3/blog-img/main/20220911171254.png)

æˆ‘ä»¬åœ¨ hello_world.asmçš„ç›®å½•ä¸‹å¾—åˆ°äº†  `hello_world.obj` ï¼Œå³ lc-3çš„å¯æ‰§è¡Œæ–‡ä»¶ã€‚

è¿è¡Œå®ƒï¼š
![|600](https://raw.githubusercontent.com/later-3/blog-img/main/20220911171443.png)

å¤ªæ£’äº†ï¼Œ`Hello World!` æˆåŠŸè¾“å‡ºäº†ã€‚

.ORIGå’Œ.STRINGZæ˜¯ä¼ªæŒ‡ä»¤ï¼Œå®ƒä»¬æŒ‡å¯¼æ±‡ç¼–å™¨ç”Ÿæˆä¸€äº›æ•°æ®æˆ–ä»£ç ï¼Œå¹¶ä¸æ˜¯CPUæ‰€è¯†åˆ«çš„æŒ‡ä»¤ã€‚ .STRINGZ æ’å…¥ä¸€æ®µå­—ç¬¦ä¸²åˆ°ç¨‹åºçš„äºŒè¿›åˆ¶ä¸­ã€‚

# 4. æ‰§è¡Œç¨‹åº
å†™è™šæ‹Ÿæœºå¹¶ä¸éœ€è¦å†™æ±‡ç¼–ä»£ç ï¼Œæ‰€ä»¥å¿«é€Ÿç»“æŸäº†ä¸Šé¢çš„ä¾‹å­ã€‚æˆ‘ä»¬çœŸæ­£éœ€è¦å…³å¿ƒçš„æ˜¯ LC-3 åˆ°åº•æ˜¯å¦‚ä½•æ‰§è¡Œç¨‹åºçš„ã€‚å®‡å®™å§‹äºä¸€ä¸ªå¥‡ç‚¹çˆ†ç‚¸ ï¼Œä»å¤§çˆ†ç‚¸ç»“æŸé‚£ä¸€åˆ»ï¼Œæ‰€æœ‰å®‡å®™ä¸­çš„äº‹åŠ¡ï¼Œæœ‰ä¸€ä¸ªåˆå§‹çš„çŠ¶æ€ï¼Œç„¶åå°±æ˜¯éšç€æ—¶é—´ä¸åœå˜åŒ–ï¼Œå˜åŒ–çš„åŸå› å¤šç§å¤šæ ·ï¼Œå°±åƒç°åœ¨çš„äººç±»ç¤¾ä¼šï¼Œä¸€ä¸ªäººå‡ºç”Ÿæ—¶ï¼Œä»–çš„å®¶åº­å°±æ˜¯ä»–çš„åˆå§‹çŠ¶æ€ï¼Œåé¢å®¶åº­å‘ç”Ÿå˜åŒ–ï¼Œè‡ªå·±éšç€å¹´é¾„å¢é•¿ï¼Œå‘ç”Ÿå˜åŒ–ï¼Œä¸åœæ”¹å˜çŠ¶æ€ã€‚ æŠ½è±¡çš„çœ‹ï¼Œæ•´ä¸ªè¿‡ç¨‹å°±åƒæ˜¯ä¸€ä¸ªç¨‹åºã€‚å¥‡ç‚¹çˆ†ç‚¸å°±æ˜¯å¼€æœºçš„ä¸€ç¬é—´ï¼Œç„¶åå¤„ç†å™¨ä»ç¬¬ä¸€æ¡ä»£ç å¼€å§‹æ‰§è¡Œï¼Œä¸€ç›´ä¸æ–­çš„æ‰§è¡Œä»£ç ï¼Œæ‰§è¡Œæ¯æ¡æ—¶ï¼Œéƒ½å¤„äºä¸€ä¸ªçŠ¶æ€ï¼Œæ‰§è¡Œå®Œåˆæ˜¯ä¸€ä¸ªçŠ¶æ€ï¼Œæ˜¯ä¸€ä¸ªçŠ¶æ€æœºã€‚ [pat67509_appc.pdf (georgetown.edu)](https://people.cs.georgetown.edu/~squier/Teaching/HardwareFundamentals/LC3-trunk/docs/LC3-uArch-PPappendC.pdf) ä¸­C.2ç« èŠ‚æœ‰è¯¦ç»†æè¿°ã€‚

LC-3å¼€æœºçš„æ—¶å€™ï¼Œåˆå§‹çŠ¶æ€æ˜¯æ€ä¹ˆæ ·çš„å‘¢ï¼Ÿï¼ˆæœ‰å…´è¶£å¯ä»¥äº†è§£ä¸‹ x86çš„å¼€æœºæ‰§è¡Œé¡ºåºï¼Œ0x7c00ï¼‰ã€‚
è¿™éƒ¨åˆ†å‚è€ƒ [[ITCS]]ç¬¬4.4ç« èŠ‚å’Œé™„å½•A [app-a (colostate.edu)](https://www.cs.colostate.edu/~cs270/.Summer22/resources/PattPatelAppA.pdf)ï¼š
- PCæŒ‡é’ˆåˆå§‹åŒ–ä¸º0x3000ï¼Œä¹Ÿå°±æ˜¯å–å†…å­˜0x3000å¤„çš„æŒ‡ä»¤ã€‚

![|250](https://raw.githubusercontent.com/later-3/blog-img/main/20220911180648.png)
ä¹Ÿå°±æ˜¯æœ€å¼€å§‹æ‰§è¡Œçš„æ˜¯OSçš„ä»£ç ï¼Œå…¶ä½™å¯„å­˜å™¨çŠ¶æ€ä¸º0ã€‚

## æ‰§è¡Œç¨‹åºæµç¨‹
1. åŠ è½½PCå¯„å­˜å™¨æŒ‡å‘çš„å†…å­˜çš„æŒ‡ä»¤ã€‚
2. å°†PCå¯„å­˜å™¨ä¸­çš„å€¼åŠ ä¸€ã€‚
3. è¯‘ç ã€‚
4. æ‰§è¡Œã€‚
5. å›åˆ°ç¬¬ä¸€æ­¥ã€‚

æ ¹æ®ä¸Šé¢çš„å™è¿°ï¼Œæˆ‘ä»¬åœ¨mainå‡½æ•°ä¸­å®Œæˆè¿™äº›å†…å®¹ã€‚
> Main Loop

```c
int main(int argc, const char* argv[])
{
	@{Load Arguments}
	@{Setup}

	/* since exactly one condition flag should be set at any given time, set the Z flag */
	reg[R_COND] = FL_ZRO;

	/* set the PC to starting position */
	/* 0x3000 is the default */
	enum { PC_START = 0x3000 };
	reg[R_PC] = PC_START;

	int running = 1;
	while (running)
	{
		/* FETCH */
		uint16_t instr = mem_read(reg[R_PC]++);
		uint16_t op = instr >> 12;

		switch (op)
		{
			case OP_ADD:
				@{ADD}
				break;
			case OP_AND:
				@{AND}
				break;
			case OP_NOT:
				@{NOT}
				break;
			case OP_BR:
				@{BR}
				break;
			case OP_JMP:
				@{JMP}
				break;
			case OP_JSR:
				@{JSR}
				break;
			case OP_LD:
				@{LD}
				break;
			case OP_LDI:
				@{LDI}
				break;
			case OP_LDR:
				@{LDR}
				break;
			case OP_LEA:
				@{LEA}
				break;
			case OP_ST:
				@{ST}
				break;
			case OP_STI:
				@{STI}
				break;
			case OP_STR:
				@{STR}
				break;
			case OP_TRAP:
				@{TRAP}
				break;
			case OP_RES:
			case OP_RTI:
			default:
				@{BAD OPCODE}
				break;
		}
	}
	@{Shutdown}
}
```

åœ¨è¿›å…¥ä¸»å¾ªç¯å‰ï¼Œæˆ‘ä»¬éœ€è¦å…ˆå¤„ç†å‚æ•°ï¼Œä½œä¸ºä¸€ä¸ªè®¡ç®—æœºæ¨¡æ‹Ÿå™¨ï¼Œæˆ‘ä»¬çš„ä»»åŠ¡æ˜¯æŠŠè®¡ç®—æœºç¨‹åºè·‘èµ·æ¥ï¼Œæ‰€ä»¥æˆ‘ä»¬è‡³å°‘æœ‰ä¸€ä¸ªè¾“å…¥å‚æ•°æ˜¯ å¯æ‰§è¡Œæ–‡ä»¶çš„è·¯å¾„ã€‚

> Load Arguments

```c
if (argc < 2)
{
	/* show usage string */
	printf("lc3 [image-file1] ...\n");
	exit(2);
}

if (!read_image(argv[1]))
{
	printf("failed to load image: %s\n", argv[1]);
	exit(1);
}
```

è¯»å–imageä¹Ÿå°±æ˜¯è¯»å– 2048.obj ç­‰äºŒè¿›åˆ¶å¯æ‰§è¡Œæ–‡ä»¶ï¼Œè¿™é‡Œæ˜¯è¦å°†äºŒè¿›åˆ¶è¯»å–åˆ° lc-3 çš„ memory ä¸­ï¼Œè¯»å–åˆ°åç§»0x3000å¼€å§‹çš„åœ°æ–¹ã€‚

# 5. æŒ‡ä»¤ç¿»è¯‘
æŠŠimageè¯»å–åˆ°å†…å­˜åï¼Œå¼€å§‹æ‰§è¡Œè¿™ä¸ªç¨‹åºäº†ï¼ŒæŒ‰ç…§é‚£5ä¸ªæ­¥éª¤ï¼Œå¼€å§‹å¾ªç¯èµ·æ¥ã€‚æ‰€ä»¥æˆ‘ä»¬è¦å®Œæˆæ¯æ¡æŒ‡ä»¤çš„å·¥ä½œï¼Œå³æŒ‡ä»¤ç¿»è¯‘ï¼Œè¿™æ˜¯æ¨¡æ‹Ÿå™¨æ ¸å¿ƒçš„å·¥ä½œã€‚ä½†è¿™å…¶å®å¹¶ä¸å¤æ‚ã€‚

## ADD
å…ˆçœ‹çœ‹æŒ‡ä»¤æ€ä¹ˆä½¿ç”¨çš„ï¼Œè¿™éƒ¨åˆ†å¯ä»¥å‚è€ƒ[[ITCS]]çš„ç¬¬äº”ç« ã€‚
> Add Register Assembly

```asm
ADD R2 R0 R1 ; add the contents of R0 to R1 and store in R2.
ADD R0 R0 1 ; add 1 to R0 and store back in R0
```

ADDå¯ä»¥å°†ä¸¤ä¸ªå¯„å­˜å™¨ç›¸åŠ ï¼Œä¹Ÿå¯ä»¥æ˜¯å¯„å­˜å™¨å’Œç«‹å³æ•°ï¼ˆç«‹å³æ•°å°±æ˜¯ä¸€ä¸ªæ•°å­—ï¼Œä»…æ­¤è€Œå·²ï¼‰ã€‚
æ¥çœ‹çœ‹ ADDçš„æŒ‡ä»¤ç¼–ç å§ï¼ˆå‚è€ƒ[app-a (jmeiners.com)](https://www.jmeiners.com/lc3-vm/supplies/lc3-isa.pdf)ï¼‰ï¼š

![](https://raw.githubusercontent.com/later-3/blog-img/main/20220911184208.png)

é€šè¿‡ç¬¬5ä¸ªbitä½æ¥åŒºåˆ†ADDçš„ä¸¤ç§æƒ…å†µï¼Œ==å‚è€ƒèµ„æ–™ç”šè‡³å°†ä»£ç éƒ½å†™å‡ºæ¥äº†==ã€‚æ‰€ä»¥æˆ‘ä»¬è·å–ç›¸åº”çš„ä½å°±èƒ½å¾—åˆ°å¯¹åº”çš„æ•°æ®ã€‚


### ç¬¦å·æ‰©å±•
ä»ä¸Šå›¾å¯ä»¥çœ‹åˆ°ï¼Œç«‹å³æ•°æ¨¡å¼ä¸‹çš„ç«‹å³æ•°åªæœ‰0~4ä¸ªbitï¼Œæ‰€ä»¥ç«‹å³æ•°åªæœ‰5ä¸ªbitä½ã€‚ä½†å¤„ç†å™¨éœ€è¦çš„æ˜¯16bitæ•°æ®ï¼ˆè¿™ä¹Ÿæ˜¯cè¯­è¨€ä¸­çš„éšå¼ç±»å‹è½¬æ¢ï¼Œå¤„ç†å™¨åªèƒ½è¿›è¡Œæ•´å‹ç®—æœ¯è¿ç®—ï¼‰ã€‚æ‰€ä»¥éœ€è¦å°†5bitå±•å¼€åˆ°16bitã€‚å¯¹äºæ­£æ•°è€Œè¨€ï¼Œå‰é¢å¡«0ï¼Œå¯¹äºè´Ÿæ•°ï¼Œå‰é¢å¡«1.ï¼ˆè¿™é‡Œæ¶‰åŠåˆ°è¡¥ç çŸ¥è¯†ï¼‰

> Sign Extend

```c
uint16_t sign_extend(uint16_t x, int bit_count)
{
	if ((x >> (bit_count - 1)) & 1) {
		x |= (0xFFFF << bit_count);
	}
	return x;
}
```

å…ˆå³ç§»4bitï¼Œå–å‡ºæœ€é«˜ä½ï¼Œå¦‚æœä¸æ˜¯1é‚£å°±æ˜¯æ­£æ•°ï¼Œå¦‚æœæ˜¯1å°±æ˜¯è´Ÿæ•°ï¼Œä¸0xFFFFæˆ–è¿ç®—ï¼Œè¡¥é½16bitã€‚


## æ¡ä»¶æ ‡è®°å¯„å­˜å™¨
æ¯æ¬¡æ‰§è¡Œå®ŒæŒ‡ä»¤åï¼Œæˆ‘ä»¬éœ€è¦æ›´æ–°æ¡ä»¶æ ‡è®°å¯„å­˜å™¨ï¼Œå°±åˆ¤æ–­ä¿å­˜è®¡ç®—ç»“æœçš„å¯„å­˜å™¨å°±å¥½äº†ã€‚

> Update Flags

```c
void update_flags(uint16_t r)
{
	if (reg[r] == 0)
	{
		reg[R_COND] = FL_ZRO;
	}
	else if (reg[r] >> 15) /* a 1 in the left-most bit indicates negative */
	{
		reg[R_COND] = FL_NEG;
	}
	else
	{
		reg[R_COND] = FL_POS;
	}
}
```

ç°åœ¨ ADD çš„ä»£ç å¯¹ä½ æ¥è¯´ï¼Œå·²ç»æ²¡æœ‰ä»€ä¹ˆç§˜å¯†äº†ã€‚


## LDI
ä»äºŒè¿›åˆ¶çš„æŒ‡ä»¤ç¼–ç åˆ°æ±‡ç¼–çš„å­—æ¯ç¼©å†™ï¼Œæ˜¯ä¸€ä¸€å¯¹åº”çš„ï¼Œå¯¹äºæ±‡ç¼–çš„ç¼©å†™ï¼Œæˆ‘ä»¬å°†å…¶å±•å¼€ï¼Œå°±èƒ½æ›´å¥½çš„äº†è§£å…¶æ„ä¹‰ã€‚
> LDI: load indirect å°†å†…å­˜ä¸­çš„å€¼åŠ è½½åˆ°å¯„å­˜å™¨ã€‚

![|500](https://raw.githubusercontent.com/later-3/blog-img/main/20220911202518.png)

<mark style="background: #FFF3A3A6;">å–å½“å‰PCçš„å€¼ï¼ŒåŠ ä¸Šæ‰©å±•åçš„åç§»ï¼Œï¼Œç„¶åè·å–å…¶å†…å­˜çš„å€¼ï¼Œè¿™ä¸ªå€¼ä»ç„¶æ˜¯ä¸€ä¸ªåœ°å€ï¼Œæˆ–è€…è¯´æ˜¯ä¸€ä¸ªæŒ‡é’ˆï¼Œæœ€åè·å–æŒ‡é’ˆçš„å€¼ã€‚</mark>

ä¾‹å­ï¼š
> LDI Sample

```c
// the value of far_data is an address
// of course far_data itself (the location in memory containing the address) has an address
char* far_data = "apple";

// In memory it may be layed out like this:

// Address Label      Value
// 0x123:  far_data = 0x456
// ...
// 0x456:  string   = 'a'

// if PC was at 0x100
// LDI R0 0x023
// would load 'a' into R0
```


# 6. æŒ‡ä»¤å¤‡å¿˜å•
æˆ‘ä»¬éœ€è¦å®Œæˆå‰©ä¸‹çš„æŒ‡ä»¤ç¿»è¯‘ï¼Œå¯¹ç…§ä¸‹é¢å†…å®¹çœ‹ä»£ç å®ç°ã€‚

> RTI & RES

ç›´æ¥ `abort()`ï¼Œå› ä¸ºè¿™ä¸¤ä¸ªæŒ‡ä»¤åœ¨LC-3æ ¹æœ¬æ²¡æœ‰ã€‚

> AND

![|500](https://raw.githubusercontent.com/later-3/blog-img/main/20220911211611.png)
è¿™å’ŒADDå‡ ä¹ä¸€è‡´ï¼Œä»…ä»…åªæ˜¯æŠŠåŠ æ³•æ“ä½œæ¢æˆäº† &
```ad-note
Examples 
AND R2, R3, R4 ;R2 â† R3 AND R4 
AND R2, R3, #7 ;R2 â† R3 AND 7
```

> NOT

![|500](https://raw.githubusercontent.com/later-3/blog-img/main/20220911212126.png)
```ad-note
Examples 
NOT R4, R2 ; R4 â† NOT(R2)
```
å°†SRå¯„å­˜å™¨çš„å€¼å–åï¼Œæ”¾åˆ°DRä¸­ï¼Œæ›´æ–°æ¡ä»¶æ ‡å¿—å¯„å­˜å™¨ã€‚

> BR

æ§åˆ¶æŒ‡ä»¤æ”¹å˜æŒ‡ä»¤æ‰§è¡Œçš„åºåˆ—ã€‚æ¡ä»¶åˆ†æ”¯è·³è½¬è¦ä¹ˆæ”¹å˜PCï¼Œè¦ä¹ˆå•¥éƒ½ä¸åšï¼Œè¿™å–å†³äºå‰ä¸€æ¡æŒ‡ä»¤æ‰§è¡Œçš„ç»“æœã€‚
<mark style="background: #D2B3FFA6;">ç”±äºæ ‡å¿—å¯„å­˜å™¨åªè®°å½•ä¸‰ç§æƒ…å†µï¼Œæ‰€ä»¥ä¸€å…±å°±åªæœ‰å››ç§æ¡ä»¶åˆ†æ”¯æ¡ä»¶ã€‚</mark>
- åˆ¤æ–­Nï¼Œå¦‚æœæ˜¯è´Ÿæ•°åˆ™è·³è½¬ ---> BRn
- åˆ¤æ–­Zï¼Œå¦‚æœæ˜¯0åˆ™è·³è½¬ ---> BRz
- åˆ¤æ–­Pï¼Œå¦‚æœæ˜¯æ­£æ•°åˆ™è·³è½¬ ---> BRp
- åˆ¤æ–­NZPï¼Œè¿™æ˜¯æ— æ¡ä»¶è·³è½¬ï¼Œå› ä¸ºä¸€å…±åªæœ‰ä¸‰ç§æƒ…å†µã€‚

ä¸Šé¢æè¿°ç­‰ä»·äºï¼š
```c
if ((n AND N) OR (z AND Z) OR (p AND P))
	PC = PCâ€¡ + SEXT(PCoffset9)
```

![|500](https://raw.githubusercontent.com/later-3/blog-img/main/20220911215443.png)

å– 9~11 ä½ï¼Œä¸æ¡ä»¶æ ‡å¿—å¯„å­˜å™¨ &ï¼Œä¸ºçœŸå°±è·³è½¬ï¼ˆPC + PCoffsetï¼‰

> RET å’Œ JMP

è¿™ä¸¤ä¸ªè·³è½¬æŒ‡ä»¤å¾ˆç®€å•ï¼Œretç›´æ¥è·³è½¬åˆ°R7å¯„å­˜å™¨çš„åœ°å€ï¼ŒJMPè·³è½¬åˆ°æŒ‡å®šçš„å¯„å­˜å™¨çš„åœ°å€ã€‚
![|500](https://raw.githubusercontent.com/later-3/blog-img/main/20220911221617.png)

```ad-note
Examples 
JMP R2 ; PC â† R2 
RET ; PC â† R7
```

äºŒè¿›åˆ¶çš„111å°±æ˜¯åè¿›åˆ¶çš„7ï¼Œæ‰€ä»¥è¿™ä¸¤æ¡æŒ‡ä»¤å¯ä»¥ç”¨åŒæ ·çš„ä»£ç å®ç°ã€‚

> JSR

Jump Register
ç±»ä¼¼ CALL æŒ‡ä»¤ï¼Œå°†å½“å‰PCä¿å­˜åˆ° R7ä¸­ï¼Œç„¶åæ ¹æ® ç¬¬11ä½åˆ¤æ–­ å¦‚ä½•å¤„ç†PCã€‚
```ad-note
Operation
R7 = PC;â€ 
if (bit[11] == 0)
----PC = BaseR;
else
----PC = PCâ€  + SEXT(PCoffset11);
```

![|500](https://raw.githubusercontent.com/later-3/blog-img/main/20220911223324.png)

> LD

Load
å°†å†…å­˜ä¸­çš„æ•°æ®åŠ è½½åˆ°å¯„å­˜å™¨ã€‚
```ad-note
Example
LD R4, VALUE ; R4 â† mem[VALUE]
```

![|500](https://raw.githubusercontent.com/later-3/blog-img/main/20220911225200.png)

> LDR

Load Register
çœ‹ä¾‹å­å°±æ¸…æ¥šäº†ã€‚
```ad-note
Example
LDR R4, R2, #âˆ’5 ; R4 â† mem[R2 âˆ’ 5]
```

![|500](https://raw.githubusercontent.com/later-3/blog-img/main/20220911225829.png)

> LEA

Load effective addres
ä¸å¤šè¯´äº†ï¼Œçœ‹Operation
```ad-note
DR = PCâ€  + SEXT(PCoffset9);
```

![|500](https://raw.githubusercontent.com/later-3/blog-img/main/20220911230343.png)

> ST

store
å°†å¯„å­˜å™¨ä¸­çš„å€¼å­˜åˆ°å†…å­˜ä¸­ã€‚
```ad-note
Operation
mem[PCâ€  + SEXT(PCoffset9)] = SR;
```
ä»£ç çš„å°±æ˜¯å¯¹Operationçš„å®ç°ã€‚
![|500](https://raw.githubusercontent.com/later-3/blog-img/main/20220911231112.png)

> STI

store indirect
æ‰€è°“é—´æ¥å­˜å‚¨ï¼Œå°±æ˜¯å†…å­˜é‡Œé¢çš„å€¼è¿˜æ˜¯ä¸€ä¸ªåœ°å€ï¼Œæˆ–è€…è¯´æŒ‡é’ˆï¼Œéœ€è¦å†å–å…¶å€¼ã€‚
```ad-note
~~~asm
mem[mem[PCâ€  + SEXT(PCoffset9)]] = SR;
~~~
```

> STR

store register
åŸºäºå¯„å­˜å™¨ä¸­ä¿å­˜çš„åœ°å€åŠ ä¸Šåç§»è·å–åˆ°ä¸€ä¸ªåœ°å€ï¼Œç„¶åå°†å¯„å­˜å™¨ä¸­çš„å€¼ä¿å­˜è¿›å»ã€‚

```ad-note
~~~asm
mem[BaseR + SEXT(offset6)] = SR;
~~~
```

![|500](https://raw.githubusercontent.com/later-3/blog-img/main/20220911232137.png)


# 7. trap routines
LC-3æä¾›äº†ä¸€äº›ç¨‹åºï¼Œå®ƒä»¬å¯ä»¥å®Œæˆä¸€äº›é€šç”¨çš„ä»»åŠ¡å’Œä¸IOè®¾å¤‡äº¤äº’ã€‚æ¯”å¦‚è¯´ï¼Œæœ‰ä»é”®ç›˜è·å–è¾“å…¥ã€å¾€å±å¹•ä¸Šè¾“å‡ºå­—ç¬¦ä¸²ã€‚å®ƒä»¬éƒ½ç§°ä¸º trap routines. æ¯ä¸ª tarp routine éƒ½æœ‰ä¸€ä¸ªå¯¹åº”çš„ trap codeã€‚å…¶å®ç®€å•æ¥è¯´ï¼Œå°±æ˜¯é¢„å…ˆå®ç°äº†ä¸€äº›å‡½æ•°ï¼Œé€šè¿‡ç±»ä¼¼ å‡½æ•°å çš„æ–¹å¼æ¥è°ƒç”¨ã€‚
è¿˜å¯ä»¥ç”¨ TRAP \#imm è¿™æ ·è°ƒç”¨ã€‚

å®é™…ç±»ä¼¼ ç³»ç»Ÿè°ƒç”¨ï¼ŒBIOSä¹Ÿç»™OSæä¾›äº†ç±»ä¼¼çš„ä¸€äº›åŠŸèƒ½ã€‚è°ƒç”¨ TRAPï¼Œå°±æ˜¯è°ƒç”¨å‡½æ•°ï¼Œé¦–å…ˆä¿å­˜ PC åˆ°R7ï¼Œç„¶åæ”¹å˜PCæŒ‡é’ˆåˆ° å¯¹åº” trap å‡½æ•°ã€‚

![|500](https://raw.githubusercontent.com/later-3/blog-img/main/20220911234235.png)

æœ‰6ä¸ªtrap routines

![](https://raw.githubusercontent.com/later-3/blog-img/main/20220911234422.png)

è·å–åˆ°TRAPæŒ‡ä»¤åï¼Œç»§ç»­åˆ¤æ–­éœ€è¦å“ªä¸ªtrap routine

```ad-note
TRAP Codes

~~~c
enum
{
    TRAP_GETC = 0x20,  /* get character from keyboard, not echoed onto the terminal */
    TRAP_OUT = 0x21,   /* output a character */
    TRAP_PUTS = 0x22,  /* output a word string */
    TRAP_IN = 0x23,    /* get character from keyboard, echoed onto the terminal */
    TRAP_PUTSP = 0x24, /* output a byte string */
    TRAP_HALT = 0x25   /* halt the program */
};
~~~
```

è¿™ä¹Ÿå°±æ˜¯ä¸ºå•¥PCçš„åˆå§‹å€¼æ˜¯ 0x3000 è€Œä¸æ˜¯0x0çš„åŸå› ï¼Œå‰é¢å­˜æ”¾ trap routines

åœ¨è£¸æœºä¸Šå®ç°è¿™äº›å‡½æ•°ï¼Œè‚¯å®šå¾—ç”¨æ±‡ç¼–ï¼Œè€Œä¸”è¿˜å¾—å’Œå¤–è®¾çš„å¯„å­˜å™¨æ‰“äº¤é“ï¼Œä¼šç¨å¾®å¤æ‚ã€‚ä½†æˆ‘ä»¬ç°åœ¨æ˜¯åœ¨å®ç°æ¨¡æ‹Ÿå™¨ï¼Œå®Œå…¨å¯ä»¥åˆ©ç”¨ç°æœ‰çš„ç¼–ç¨‹æ¥å£ï¼Œæ¯”å¦‚ï¼Œå¾€å±å¹•è¾“å‡ºç”¨putså°±å¥½äº†ï¼ˆç”¨printfä¹Ÿå¯ä»¥çš„ï¼Œæˆ‘è§‰å¾—ï¼‰ã€‚

trap routine çš„å®ç°éå¸¸ç®€å•ï¼Œå¯¹ç…§ä¸Šé¢trap tableå°±è¡Œã€‚


# 8. LC-3 endianness
LC-3æ˜¯å¤§ç«¯çš„ï¼Œç°åœ¨çš„è®¡ç®—æœºå¤§å¤šæ•°éƒ½æ˜¯å°ç«¯çš„ï¼Œæˆ‘ä»¬éœ€è¦å¤§å°è½¬æ¢ã€‚

# 9. å†…å­˜æ˜ å°„å¯„å­˜å™¨
å¦‚åŒarmä¸€æ ·ï¼Œå°†å¯„å­˜å™¨æ˜ å°„åˆ°å¯»å€ç©ºé—´ä¸­ï¼Œå°±å¦‚åŒè®¿é—®å†…å­˜ä¸€æ ·ï¼Œè¯»å†™è¿™å†™åœ°å€å°±å¦‚åŒè¯»å†™å¤–è®¾çš„å¯„å­˜å™¨ã€‚

é”®ç›˜æœ‰ä¸¤ä¸ªå¯„å­˜å™¨ï¼š
- keyboard status register ---> KBSR
- keyboard data register ---> KBDR

KBSR è¡¨ç¤ºæ˜¯å¦æœ‰é”®è¢«æŒ‰ä¸‹ï¼ŒKBDRè¡¨ç¤ºå“ªä¸ªé”®è¢«æŒ‰ä¸‹äº†ã€‚

å°½ç®¡å¯ä»¥ä½¿ç”¨ GETC è¯·æ±‚é”®ç›˜è¾“å…¥ï¼Œä½†è¿™ä¼šé˜»æ­¢æ‰§è¡Œï¼Œç›´åˆ°æ¥æ”¶åˆ°è¾“å…¥ä¸ºæ­¢ã€‚KBSR å’Œ KBDR å…è®¸æ‚¨è½®è¯¢è®¾å¤‡çš„çŠ¶æ€)å¹¶ç»§ç»­æ‰§è¡Œï¼Œå› æ­¤ç¨‹åºå¯ä»¥åœ¨ç­‰å¾…è¾“å…¥æ—¶ä¿æŒå“åº”ã€‚

é€šå¸¸æŒ‰é”®éƒ½æ˜¯è§¦å‘ä¸­æ–­ï¼Œè€Œè¿™é‡Œä½¿ç”¨è½®è¯¢çš„æ–¹å¼ã€‚å½“2048æ¸¸æˆå¼€å§‹ï¼Œç¬¬ä¸€å‰¯æ¸¸æˆæ£‹ç›˜æ‘†å¥½åï¼Œå°±ä¼šç­‰å¾…ç”¨æˆ·çš„æŒ‰é”®ï¼Œæ­¤æ—¶ä¼šä¸€ç›´è¯»å–é”®ç›˜çš„KBSRï¼Œåˆ¤æ–­æ˜¯å¦æœ‰æŒ‰é”®è¢«æŒ‰ä¸‹ã€‚

é”®ç›˜å¯„å­˜å™¨çš„åœ°å€ï¼š
![|500](https://raw.githubusercontent.com/later-3/blog-img/main/20220912105840.png)

# 10. ä¼˜åŒ–
æœ‰äº›å‡½æ•°çš„åŠŸèƒ½laterä¹Ÿæ²¡æœ‰æå¾—å¾ˆæ¸…æ¥šï¼Œä½†é‚£äº›åªæ˜¯ä¸ºäº†æ›´å¥½çš„å’Œé”®ç›˜äº’åŠ¨ï¼Œå’Œè™šæ‹Ÿæœºæ— å…³. So feel free to copy paste!
```ad-note
function
~~~c
void disable_input_buffering()
void restore_input_buffering()
uint16_t check_key()
~~~
```

# 11. æ€»ç»“
æœ¬æ–‡ä»‹ç»äº†lc3-vmçš„å¾ˆå¤šç»†èŠ‚ï¼Œè¯¦ç»†è¯»è€…èƒ½å¤Ÿè½»æ¾çš„è¯»æ‡‚æ•´ä¸ªå‡ ç™¾è¡Œçš„ä»£ç ï¼Œ[ä»“åº“åœ¨è¿™é‡Œ](https://github.com/justinmeiners/lc3-vm)
ä½†lc3èƒŒåçš„æ•…äº‹æ›´åŠ å¸å¼•äººï¼Œè¿™æ˜¯ä»åå¤šå¹´å‰å°±å¼€å§‹çš„ä¸€ä¸ªé¡¹ç›®ï¼Œ<mark style="background: #FFB8EBA6;">å†æ¬¡å¼ºè°ƒï¼Œlc3çš„ä½œè€…ä»¥è‡ªåº•å‘ä¸Šçš„æ€æƒ³ï¼Œå®Œæˆäº†ä¸€ä¸ª16bit è®¡ç®—æœºçš„è®¾è®¡å’Œå®ç°ï¼Œä»é—¨ç”µè·¯åˆ°ISAï¼Œåˆ°æŒ‡ä»¤é›†è®¾è®¡ï¼Œå¹¶å®Œæˆäº†lc3çš„è™šæ‹Ÿæœºå®ç°ï¼Œæ±‡ç¼–åˆ°æŒ‡ä»¤çš„ç¿»è¯‘ï¼Œç”šè‡³cè¯­è¨€åˆ°lc3æŒ‡ä»¤çš„ç¿»è¯‘ï¼Œè¿˜æœ‰ä¸€ä¸ªlaterè¿˜æœªæ¢ç´¢çš„lc3osï¼</mark> 
å‘è¿™äº›å…ˆé©±è‡´æ•¬ï¼Œæä¾›äº†è¿™ä¹ˆå¥½çš„èµ„æºï¼Œå¹¶ä¸”laterååˆ†è®¤åŒ è‡ªåº•å‘ä¸Š çš„å­¦ä¹ æ–¹æ³•ã€‚
EnjoyğŸ˜


# å‚è€ƒ
å‚è€ƒåŸæ–‡ï¼š[Write your Own Virtual Machine (jmeiners.com)](https://www.jmeiners.com/lc3-vm/?source=post_page---------------------------) 
ä»£ç ä»“åº“ï¼š[justinmeiners/lc3-vm: Write your own virtual machine for the LC-3 computer! (github.com)](https://github.com/justinmeiners/lc3-vm)
[[|ITCS]]ï¼š[Introduction To Computing Systems: From Bits & Gates To C/C++ & Beyond, Third Edition (icourse.club)](https://icourse.club/uploads/files/96a2b94d4be48285f2605d843a1e6db37da9a944.pdf)
[Lecture_10-310h.ppt (utexas.edu)](https://www.cs.utexas.edu/users/fussell/courses/cs310h/lectures/Lecture_10-310h.pdf)
[CS 345 (byu.edu)](https://students.cs.byu.edu/~cs345ta/)
[ECE120: Introduction to Computing, Spring 2019 ZJUI Section (illinois.edu)](https://lumetta.web.engr.illinois.edu/120-S19/)

