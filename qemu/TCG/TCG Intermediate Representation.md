#TCG #QEMU 

# 简介
TCG (微型代码生成器)最初是作为 C 编译器的通用后端。它被简化为在 QEMU 中使用。它的根源还在于 Paul Brook 编写的 QOP 代码生成器。

# 名词定义
TCG target是我们生成代码的架构.由于 TCG 最初是用于交叉编译的通用 C 后端，因此假设 TCG 目标可能与主机不同，尽管 QEMU 从来不是这种情况。

在这个文档中，我们使用 guest 来指定我们要仿真的体系结构; target 总是指 TCG 目标，也就是我们运行 QEMU 的机器。

# 基本块
TCG 基本块是一个单个条目、多个退出区域，它对应于由标签终止的指令列表或任何分支指令。
TCG 扩展基本块是一个单入口、多出口区域，它对应于由标签或无条件分支终止的指令列表。具体来说，扩展基本块是由零条件分支指令或更多条件分支指令的落入路径连接的基本块序列。

# 操作
TCG 指令或操作对 TCG 变量进行操作，这两个变量都是强类型的。每条指令都有固定数量的输出变量操作数、输入变量操作数和常数操作数。向量指令有一个字段指定向量中元素的大小。值得注意的例外是调用指令，它的输出和输入数量是可变的。
在文本形式中，输出操作数通常放在第一位，接着是输入操作数，然后是常数操作数。输出类型包含在指令名中。常量的前缀是“ $”。
```
add_i32 t0, t1, t2    /* (t0 <- t1 + t2) */
```

# 变量
- TEMP_FIXED
有一个 TCG 固定的全局变量 cpu _ env，它存在于所有的转换块中，并持有一个指向 CPUArchState 的指针。此变量在所有转换块中始终保存在主机 CPU 寄存器中。
- TEMP_GLOBAL
TCG 全局变量存在于所有转换块中，并且对应于 CPUArchState 中的内存位置。它们可以指定为 cpu _ env 的偏移量，在这种情况下，它们被称为直接全局，或者可以指定为直接全局的偏移量，在这种情况下，它们被称为间接全局。即使是间接全局变量也应该引用 CPUArchState 内的内存。所有 TCG 全局变量都是在 TCGCPUOps.initialize 期间定义的，在生成任何转换块之前。
- TEMP_CONST
TCG 常量是一个变量，它存在于整个翻译块中，并且包含一个常量值。这些变量在转换过程中根据需要分配，并进行散列，以便只有一个变量保存给定的值。
- TEMP_TB
TCG 翻译块临时是一个变量，它在整个翻译块中都存在，但是在任何出口都会消失。这些临时用户在翻译期间显式分配。
- TEMP_EBB
TCG 扩展的基本块临时是一个变量，它在扩展的基本块中存在，但在任何退出时都会消失。这些临时用户在翻译期间显式分配。

# 为获得最佳性能而推荐的编码规则
- 使用全局来表示 QEMU CPU 状态中经常被修改的部分，例如整数寄存器和条件代码。TCG 将能够使用主机寄存器来存储它们。
- 对于复杂的或很少使用的guest instructions. 不要犹豫使用helpers。使用 TCG 实现带有大约20条以上 TCG 指令的guest instructions几乎没有性能优势。请注意，这个经验法则更适用于做复杂逻辑或算术的helpers，其中 C 编译器有范围做一个很好的优化工作; 它不太相关的指令主要是做加载和存储，在这些情况下，内联 TCG 可能仍然更快的长序列。