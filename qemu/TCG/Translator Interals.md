#TCG #QEMU 

# 翻译器内部原理
QEMU是一个动态翻译器。当QEMU第一次接收到一段代码，它会将这段代码转换成host指令集。通常动态翻译器是非常复杂的，同时也高度依赖CPU。QEMU使用了一些tricks，使动态翻译相对来说简单可移植，同时获得良好的性能。

QEMU的动态翻译后端叫做TCG，表示Tiny Code Generator。更多的信息，可以参考[TCG Intermediate Representation](https://www.qemu.org/docs/master/devel/tcg-ops.html#tcg-ops-ref).

以下部分概述了 QEMU 的动态翻译器的一些显著特性和实现细节。

# CPU 状态优化
目标 CPU 有许多内部状态，这些状态改变了它们评估指令的方式。为了获得良好的速度，转换阶段认为虚拟 CPU 的某些状态信息不能在其中变化。状态记录在翻译块(TB)中。如果状态发生变化(例如特权级别) ，将生成一个新的 TB，并且在状态与前一个 TB 中记录的状态匹配之前，将不再使用前一个 TB。同样的思想也可以应用到 CPU 状态的其他方面。例如，在 x86上，如果 SS、 DS 和 ES 段有一个零基，那么翻译器甚至不会为段基生成一个附加值。

# 直接块链接
在执行每个已翻译的基本块之后，QEMU 使用模拟 Program Counter (PC)和其他 CPU 状态信息(例如 CS 段基值)来查找下一个基本块。

在其最简单、优化程度较低的形式中，这是通过从当前 TB 退出、浏览 TB 后记、然后返回到主循环来完成的。这就是 QEMU 寻找下一个要执行的 TB 的地方，如果内存中还没有可用的话，就从客户体系结构转换它。然后 QEMU 继续执行下一个 TB，从序言开始，然后转到翻译后的指令。

在任何可能取消掩码中断的 CPU 状态更改之后，必须以这种方式退出。

为了加快新模拟 PC 的 TB 已经可用的情况，QEMU 具有允许直接链接多个 TB 的机制，而不必回到上面描述的主循环。这些机制包括:

